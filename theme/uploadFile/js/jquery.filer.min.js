/*!
 * jQuery.filer
 * Copyright (c) 2015 CreativeDream
 * Website: http://creativedream.net/plugins/jquery.filer
 * Version: 1.0 (30-01-2015)
 * Requires: jQuery v1.7.1 or later
 */
(function(e){"use strict";e.fn.filer=function(t){return this.each(function(n,r){var i=e(r),s=".jFiler",o=e(),u=e(),a=e(),f=[],l=e.extend(true,{},e.fn.filer.defaults,t),c={init:function(){i.wrap('<div class="jFiler"></div>');o=i.closest(s);c._changeInput()},_bindInput:function(){if(l.changeInput&&u.size()>0){u.bind("click",c._clickHandler)}i.on({focus:function(){u.addClass("focused")},blur:function(){u.removeClass("focused")},change:function(){c._onChange()}});if(l.dragDrop){(u.length>0?u:i).bind("drop",c._dragDrop.drop).bind("dragover",c._dragDrop.dragEnter).bind("dragleave",c._dragDrop.dragLeave)}if(l.uploadFile&&l.clipBoardPaste){e(window).on("paste",c._clipboardPaste)}},_unbindInput:function(){if(l.changeInput&&u.size()>0){u.unbind("click",c._clickHandler)}},_clickHandler:function(){i.click()},_applyAttrSettings:function(){var e=["name","limit","maxSize","extensions","changeInput","showThumbs","appendTo","theme","addMore","excludeName","files"];for(var t in e){var n="data-jfiler-"+e[t];if(c._assets.hasAttr(n)){switch(e[t]){case"changeInput":case"showThumbs":case"addMore":l[e[t]]=["true","false"].indexOf(i.attr(n))>-1?i.attr(n)=="true":i.attr(n);break;case"extensions":l[e[t]]=i.attr(n).replace(/ /g,"").split(",");break;case"files":l[e[t]]=JSON.parse(i.attr(n));break;default:l[e[t]]=i.attr(n)}i.removeAttr(n)}}},_changeInput:function(){c._applyAttrSettings();if(l.theme){o.addClass("jFiler-theme-"+l.theme)}if(i.get(0).tagName.toLowerCase()!="input"&&i.get(0).type!="file"){u=i;i=e('<input type="file" name="'+l.name+'" />');i.css({position:"absolute",left:"-9999px",top:"-9999px","z-index":"-9999"});o.prepend(i);c._isGn=i}else{if(l.changeInput){switch(typeof l.changeInput){case"boolean":u=e('<div class="jFiler-input"><div class="jFiler-input-caption"><span>'+l.captions.feedback+'</span></div><div class="jFiler-input-button">'+l.captions.button+'</div></div>"');break;case"string":case"object":u=e(l.changeInput);break;case"function":u=e(l.changeInput(o,i,l));break}i.after(u);i.css({position:"absolute",left:"-9999px",top:"-9999px","z-index":"-9999"})}}if(!l.limit||l.limit&&l.limit>=2){i.attr("multiple","multiple");i.attr("name").slice(-2)!="[]"?i.attr("name",i.attr("name")+"[]"):null}c._bindInput();if(l.files){c._append(false,{files:l.files})}},_clear:function(){c.files=null;if(!l.uploadFile&&!l.addMore){c._reset()}c._set("feedback",c._itFl&&c._itFl.length>0?c._itFl.length+" "+l.captions.feedback2:l.captions.feedback);l.onEmpty!=null&&typeof l.onEmpty=="function"?l.onEmpty(o,u,i):null},_reset:function(t){if(!t){if(!l.uploadFile&&l.addMore){for(var n=0;n<f.length;n++){f[n].remove()}f=[];c._unbindInput();if(c._isGn){i=c._isGn}else{i=e(r)}c._bindInput()}c._set("input","")}c._itFl=[];c._itFc=null;o.find("input[name^='jfiler-items-exclude-']:hidden").remove();a.fadeOut("fast",function(){e(this).remove()});a=e()},_set:function(e,t){switch(e){case"input":i.val("");break;case"feedback":if(u.length>0){u.find(".jFiler-input-caption span").html(t)}break}},_filesCheck:function(){var t=0;if(l.limit&&c.files.length+c._itFl.length>l.limit){alert(c._assets.textParse(l.captions.errors.filesLimit));return false}for(var n=0;n<c.files.length;n++){var r=c.files[n].name.split(".").pop().toLowerCase(),i=c.files[n],s={name:i.name,size:i.size,size2:c._assets.bytesToSize(i.size),type:i.type,ext:r};if(l.extensions!=null&&e.inArray(r,l.extensions)==-1){alert(c._assets.textParse(l.captions.errors.filesType,s));return false;break}if(l.maxSize!=null&&c.files[n].size>l.maxSize*1048576){alert(c._assets.textParse(l.captions.errors.filesSize,s));return false;break}if(i.size==4096&&i.type.length==0){return false;break}t+=c.files[n].size}if(l.maxSize!=null&&t>=Math.round(l.maxSize*1048576)){alert(c._assets.textParse(l.captions.errors.filesSizeAll));return false}if(l.addMore||l.uploadFile){var s=c._itFl.filter(function(e,t){if(e.file.name==i.name&&e.file.size==i.size&&e.file.type==i.type&&(i.lastModified?e.file.lastModified==i.lastModified:true)){return true}});if(s.length>0){return false}}return true},_thumbCreator:{create:function(t){var n=c.files[t],r=c._itFc?c._itFc.id:t,i=n.name,s=n.size,o=n.type.split("/",1).toString().toLowerCase(),u=i.indexOf(".")!=-1?i.split(".").pop().toLowerCase():"",f=l.uploadFile?'<div class="jFiler-jProgressBar">'+l.templates.progressBar+"</div>":"",h={id:r,name:i,size:s,size2:c._assets.bytesToSize(s),type:o,extension:u,icon:c._assets.getIcon(u,o),icon2:c._thumbCreator.generateIcon({type:o,extension:u}),image:'<div class="jFiler-item-thumb-image fi-loading"></div>',progressBar:f,_appended:n._appended},p="";if(n.opts){h=e.extend({},n.opts,h)}p=e(c._thumbCreator.renderContent(h)).attr("data-jfiler-index",r);p.get(0).jfiler_id=r;c._thumbCreator.renderFile(n,p,h);if(n.forList){return p}c._itFc.html=p;p.hide()[l.templates.itemAppendToEnd?"appendTo":"prependTo"](a.find(l.templates._selectors.list)).show();if(!n._appended){c._onSelect(t)}},renderContent:function(e){return c._assets.textParse(e._appended?l.templates.itemAppend:l.templates.item,e)},renderFile:function(t,n,r){if(n.find(".jFiler-item-thumb-image").size()==0){return false}if(t.file&&r.type=="image"){var i='<img src="'+t.file+'" draggable="false" />',s=n.find(".jFiler-item-thumb-image.fi-loading");e(i).error(function(){i=c._thumbCreator.generateIcon(r);n.addClass("jFiler-no-thumbnail");s.removeClass("fi-loading").html(i)}).load(function(){s.removeClass("fi-loading").html(i)});return true}if(window.File&&window.FileList&&window.FileReader&&r.type=="image"){var o=new FileReader;o.onload=function(t){var i='<img src="'+t.target.result+'" draggable="false" />',s=n.find(".jFiler-item-thumb-image.fi-loading");e(i).error(function(){i=c._thumbCreator.generateIcon(r);n.addClass("jFiler-no-thumbnail");s.removeClass("fi-loading").html(i)}).load(function(){s.removeClass("fi-loading").html(i)})};o.readAsDataURL(t)}else{var i=c._thumbCreator.generateIcon(r),s=n.find(".jFiler-item-thumb-image.fi-loading");n.addClass("jFiler-no-thumbnail");s.removeClass("fi-loading").html(i)}},generateIcon:function(t){var n=new Array(3);if(t&&t.type&&t.extension){switch(t.type){case"image":n[0]="f-image";n[1]='<i class="icon-jfi-file-image"></i>';break;case"video":n[0]="f-video";n[1]='<i class="icon-jfi-file-video"></i>';break;case"audio":n[0]="f-audio";n[1]='<i class="icon-jfi-file-audio"></i>';break;default:n[0]="f-file f-file-ext-"+t.extension;n[1]=t.extension.length>0?"."+t.extension:"";n[2]=1}}else{n[0]="f-file";n[1]=t.extension&&t.extension.length>0?"."+t.extension:"";n[2]=1}var r='<span class="jFiler-icon-file '+n[0]+'">'+n[1]+"</span>";if(n[2]==1){var i=c._assets.text2Color(t.extension);if(i){var s=e(r).appendTo("body"),o=s.css("box-shadow");o=i+o.substring(o.replace(/^.*(rgba?\([^)]+\)).*$/,"$1").length,o.length);s.css({"-webkit-box-shadow":o,"-moz-box-shadow":o,"box-shadow":o});r=s.prop("outerHTML");s.remove()}}return r},_box:function(t){if(l.beforeShow!=null&&typeof l.beforeShow=="function"?!l.beforeShow(c.files,a,o,u,i):false){return false}if(a.length<1){if(l.appendTo){var n=e(l.appendTo)}else{var n=o}n.find(".jFiler-items").remove();a=e('<div class="jFiler-items jFiler-row"></div>');a.append(c._assets.textParse(l.templates.box)).appendTo(n);a.on("click",l.templates._selectors.remove,function(n){n.preventDefault();var r=l.templates.removeConfirmation?confirm(l.captions.removeConfirmation):true;if(r){c._remove(t?t.remove.event:n,t?t.remove.el:e(this).closest(l.templates._selectors.item))}})}for(var r=0;r<c.files.length;r++){c._addToMemory(r);c._thumbCreator.create(r)}}},_upload:function(t){var n=c._itFc.html,r=new FormData;r.append(i.attr("name"),c._itFc.file,c._itFc.file.name?c._itFc.file.name:false);if(l.uploadFile.data!=null&&e.isPlainObject(l.uploadFile.data)){for(k in l.uploadFile.data){r.append(k,l.uploadFile.data[k])}}c._ajax.send(n,r,c._itFc)},_ajax:{send:function(t,n,r){r.ajax=e.ajax({url:l.uploadFile.url,data:n,type:l.uploadFile.type,enctype:l.uploadFile.enctype,xhr:function(){var n=e.ajaxSettings.xhr();if(n.upload){n.upload.addEventListener("progress",function(e){c._ajax.progressHandling(e,t)},false)}return n},complete:function(){r.ajax=false},beforeSend:function(e,n){return l.uploadFile.beforeSend!=null&&typeof l.uploadFile.beforeSend=="function"?l.uploadFile.beforeSend(t,a,o,u,i,e,n):true},success:function(e,n,s){r.uploaded=true;l.uploadFile.success!=null&&typeof l.uploadFile.success=="function"?l.uploadFile.success(e,t,a,o,u,i,n,s):null},error:function(e,n,s){r.uploaded=false;l.uploadFile.error!=null&&typeof l.uploadFile.error=="function"?l.uploadFile.error(t,a,o,u,i,e,n,s):null},statusCode:l.uploadFile.statusCode,cache:false,contentType:false,processData:false});return r.ajax},progressHandling:function(e,t){if(e.lengthComputable){var n=Math.round(e.loaded*100/e.total).toString();l.uploadFile.onProgress!=null&&typeof l.uploadFile.onProgress=="function"?l.uploadFile.onProgress(n,t,a,o,u,i):null;t.find(".jFiler-jProgressBar").find(l.templates._selectors.progressBar).css("width",n+"%")}}},_dragDrop:{dragEnter:function(e){e.preventDefault();e.stopPropagation();o.addClass("dragged");c._set("feedback",l.captions.drop);l.dragDrop.dragEnter!=null&&typeof l.dragDrop.dragEnter=="function"?l.dragDrop.dragEnter(e,u,i,o):null},dragLeave:function(e){e.preventDefault();e.stopPropagation();if(!c._dragDrop._dragLeaveCheck(e)){return false}o.removeClass("dragged");c._set("feedback",l.captions.feedback);l.dragDrop.dragLeave!=null&&typeof l.dragDrop.dragLeave=="function"?l.dragDrop.dragLeave(e,u,i,o):null},drop:function(e){e.preventDefault();o.removeClass("dragged");if(!e.originalEvent.dataTransfer.files||e.originalEvent.dataTransfer.files.length<=0){return}c._set("feedback",l.captions.feedback);c._onChange(e,e.originalEvent.dataTransfer.files);l.dragDrop.drop!=null&&typeof l.dragDrop.drop=="function"?l.dragDrop.drop(e.originalEvent.dataTransfer.files,e,u,i,o):null},_dragLeaveCheck:function(t){var n=t.relatedTarget,r=false;if(n!==u){if(n){r=e.contains(u,n)}if(r){return false}}return true}},_clipboardPaste:function(e,t){if(!t&&!e.originalEvent.clipboardData&&!e.originalEvent.clipboardData.items){return}if(t&&!e.originalEvent.dataTransfer&&!e.originalEvent.dataTransfer.items){return}if(c._clPsePre){return}var n=t?e.originalEvent.dataTransfer.items:e.originalEvent.clipboardData.items,r=function(e,t,n){t=t||"";n=n||512;var r=atob(e);var i=[];for(var s=0;s<r.length;s+=n){var o=r.slice(s,s+n);var u=new Array(o.length);for(var a=0;a<o.length;a++){u[a]=o.charCodeAt(a)}var f=new Uint8Array(u);i.push(f)}var l=new Blob(i,{type:t});return l};if(n){for(var i=0;i<n.length;i++){if(n[i].type.indexOf("image")!==-1||n[i].type.indexOf("text/uri-list")!==-1){if(t){try{window.atob(e.originalEvent.dataTransfer.getData("text/uri-list").toString().split(",")[1])}catch(e){return}}var s=t?r(e.originalEvent.dataTransfer.getData("text/uri-list").toString().split(",")[1],"image/png"):n[i].getAsFile();s.name=Math.random().toString(36).substring(5);s.name+=s.type.indexOf("/")!=-1?"."+s.type.split("/")[1].toString().toLowerCase():".png";c._onChange(e,[s]);c._clPsePre=setTimeout(function(){delete c._clPsePre},1e3)}}}},_onSelect:function(t){if(l.uploadFile&&!e.isEmptyObject(l.uploadFile)){c._upload(t)}l.onSelect!=null&&typeof l.onSelect=="function"?l.onSelect(c.files[t],c._itFc.html,a,o,u,i):null;if(t+1>=c.files.length){l.afterShow!=null&&typeof l.afterShow=="function"?l.afterShow(a,o,u,i):null}},_onChange:function(t,n){if(!n){if(!i.get(0).files||typeof i.get(0).files=="undefined"||i.get(0).files.length==0){if(!l.uploadFile&&!l.addMore){c._set("input","");c._clear()}return false}c.files=i.get(0).files}else{if(!n||n.length==0){c._set("input","");c._clear();return false}c.files=n}if(!l.uploadFile&&!l.addMore){c._reset(true)}if(!c._filesCheck()){c._set("input","");c._clear();return false}c._set("feedback",c.files.length+c._itFl.length+" "+l.captions.feedback2);if(l.showThumbs){c._thumbCreator._box()}else{for(var r=0;r<c.files.length;r++){c._addToMemory(r);c._onSelect(r)}}if(!l.uploadFile&&l.addMore){var s=e('<input type="file" />');var o=i.prop("attributes");e.each(o,function(){s.attr(this.name,this.value)});i.after(s);c._unbindInput();f.push(s);i=s;c._bindInput()}},_append:function(e,t){var n=!t?false:t.files;if(!n||n.length<=0){return}c.files=n;if(l.showThumbs){for(var r=0;r<c.files.length;r++){c.files[r]._appended=true}c._thumbCreator._box()}},_getList:function(e,t){var n=!t?false:t.files;if(!n||n.length<=0){return}c.files=n;if(l.showThumbs){var r=[];for(var s=0;s<c.files.length;s++){c.files[s].forList=true;r.push(c._thumbCreator.create(s))}if(t.callback){t.callback(r,a,o,u,i)}}},_remove:function(t,r){if(r.binded){if(r.data.id){r=a.find(l.templates._selectors.item+"[data-jfiler-index='"+r.data.id+"']");if(r.size()==0){return false}}if(r.data.el){r=r.data.el}}var s=r.get(0).jfiler_id||r.attr("data-jfiler-index"),f=null,h=function(t){var r=o.find("input[name^='jfiler-items-exclude-']:hidden").first(),s=c._itFl[t].file,u=[];if(r.size()==0){r=e('<input type="hidden" name="jfiler-items-exclude-'+(l.excludeName?l.excludeName:(i.attr("name").slice(-2)!="[]"?i.attr("name"):i.attr("name").substring(0,i.attr("name").length-2))+"-"+n)+'">');r.appendTo(o)}else{u=JSON.parse(r.val())}u.push(s.name);u=JSON.stringify(u);r.val(u)},d=function(t,n){h(n);c._itFl.splice(n,1);if(c._itFl.length<1){c._reset();c._clear()}else{c._set("feedback",c._itFl.length+" "+l.captions.feedback2)}t.fadeOut("fast",function(){e(this).remove()})};for(var v in c._itFl){if(v==="length"||!c._itFl.hasOwnProperty(v))continue;if(c._itFl[v].id==s){f=v}}if(!c._itFl.hasOwnProperty(f)){return false}if(c._itFl[f].ajax){c._itFl[f].ajax.abort();d(r,f);return}l.onRemove!=null&&typeof l.onRemove=="function"?l.onRemove(r,c._itFl[f].file,f,a,o,u,i):null;d(r,f)},_addToMemory:function(t){c._itFl.push({id:c._itFl.length,file:c.files[t],html:e(),ajax:false,uploaded:false});c._itFc=c._itFl[c._itFl.length-1]},_assets:{bytesToSize:function(e){if(e==0)return"0 Byte";var t=1e3;var n=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"];var r=Math.floor(Math.log(e)/Math.log(t));return(e/Math.pow(t,r)).toPrecision(3)+" "+n[r]},hasAttr:function(e,t){var t=!t?i:t,n=t.attr(e);if(!n||typeof n=="undefined"){return false}else{return true}},getIcon:function(t,n){var r=["audio","image","text","video"];if(e.inArray(n,r)>-1){return'<i class="icon-jfi-file-'+n+" jfi-file-ext-"+t+'"></i>'}return'<i class="icon-jfi-file-o jfi-file-type-'+n+" jfi-file-ext-"+t+'"></i>'},textParse:function(t,n){n=e.extend({},{limit:l.limit,maxSize:l.maxSize},n&&e.isPlainObject(n)?n:{});switch(typeof t){case"string":return t.replace(/\{\{fi-(.*?)\}\}/g,function(e,t){t=t.replace(/ /g,"");if(t.match(/(.*?)\|limitTo\:(\d+)/)){return t.replace(/(.*?)\|limitTo\:(\d+)/,function(e,t,r){var t=n[t]?n[t]:"",i=t.substring(0,r);i=t.length>i.length?i.substring(0,i.length-3)+"...":i;return i})}else{return n[t]?n[t]:""}});break;case"function":return t(n);break;default:return t}},text2Color:function(e){if(!e||e.length==0){return false}for(var t=0,n=0;t<e.length;n=e.charCodeAt(t++)+((n<<5)-n));for(var t=0,r="#";t<3;r+=("00"+(n>>t++*2&255).toString(16)).slice(-2));return r}},files:null,_itFl:[],_itFc:null};c.init();i.on("filer.append",function(e,t){c._append(e,t)});i.on("filer.remove",function(e,t){t.binded=true;c._remove(e,t)});i.on("filer.reset",function(e){c._reset();c._clear();return true});i.on("filer.generateList",function(e,t){return c._getList(e,t)});return this})};e.fn.filer.defaults={limit:null,maxSize:null,extensions:null,changeInput:true,showThumbs:false,appendTo:null,theme:null,templates:{box:null,item:null,itemAppend:null,progressBar:null,itemAppendToEnd:false,removeConfirmation:true,_selectors:{list:null,item:null,progressBar:null,remove:null}},files:null,uploadFile:null,dragDrop:null,addMore:false,clipBoardPaste:true,excludeName:null,beforeShow:null,onSelect:null,afterShow:null,onRemove:null,onEmpty:null,captions:{button:"Choose Files",feedback:"Choose files To Upload",feedback2:"files were chosen",drop:"Drop file here to Upload",removeConfirmation:"Are you sure you want to remove this file?",errors:{filesLimit:"Only {{fi-limit}} files are allowed to be uploaded.",filesType:"Only Images are allowed to be uploaded.",filesSize:"{{fi-name}} is too large! Please upload file up to {{fi-maxSize}} MB.",filesSizeAll:"Files you've choosed are too large! Please upload files up to {{fi-maxSize}} MB."}}}})(jQuery)